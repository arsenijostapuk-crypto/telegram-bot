import os
from flask import Flask, request
import telebot
from telebot import types

# –Ü–º–ø–æ—Ä—Ç –º–µ–Ω—é –∑ keyboards.py
from keyboards import (
    main_menu,
    assortment_menu,
    liquids_menu,
    pods_menu,
    cartridges_menu,
    delivery_menu,
    order_menu,
    info_menu
)

app = Flask(__name__)

# ==================== –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ====================
TOKEN = os.getenv("MY_BOT_TOKEN")
if not TOKEN:
    raise ValueError("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ! –í—Å—Ç–∞–Ω–æ–≤–∏ MY_BOT_TOKEN —É Render.")

bot = telebot.TeleBot(TOKEN)

# ID –≥—Ä—É–ø–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤ (–ó–ê–ú–Ü–ù–ò–¢–ò –Ω–∞ —Å–≤—ñ–π!)
ADMIN_GROUP_ID = -1003654920245
# –°–ª–æ–≤–Ω–∏–∫ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–Ω—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
user_states = {}

# ==================== –¢–ï–ö–°–¢–ò –ü–û–í–Ü–î–û–ú–õ–ï–ù–¨ ====================
WELCOME_TEXT = """
üëã *–í—ñ—Ç–∞—î–º–æ –≤ –Ω–∞—à–æ–º—É –±–æ—Ç—ñ!*

–û–±–∏—Ä–∞–π—Ç–µ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π —Ä–æ–∑–¥—ñ–ª:

üõçÔ∏è *–ê—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç* - –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ç–æ–≤–∞—Ä–∏
üöö *–î–æ—Å—Ç–∞–≤–∫–∞* - —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É
üì¶ *–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è* - —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
‚ÑπÔ∏è *–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ* - —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –±–æ—Ç–∞

–û–±–µ—Ä—ñ—Ç—å –ø—É–Ω–∫—Ç –º–µ–Ω—é üëá
"""

DELIVERY_TEXT = """
üöö *–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É*

üìç *–°–ø–æ—Å–æ–±–∏ –¥–æ—Å—Ç–∞–≤–∫–∏:*
‚Ä¢ –ù–æ–≤–∞ –ø–æ—à—Ç–∞
‚Ä¢ –£–∫—Ä–ø–æ—à—Ç–∞
‚Ä¢ –°–∞–º–æ–≤–∏–≤—ñ–∑ (–º. –ö–∏—ó–≤)

‚è∞ *–¢–µ—Ä–º—ñ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏:*
‚Ä¢ –ü–æ –ö–∏—î–≤—É: 1-2 –¥–Ω—ñ
‚Ä¢ –ü–æ –£–∫—Ä–∞—ó–Ω—ñ: 2-5 –¥–Ω—ñ–≤

üí∞ *–í–∞—Ä—Ç—ñ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏:*
‚Ä¢ –í—ñ–¥ 50 –≥—Ä–Ω (–∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –ø–µ—Ä–µ–≤—ñ–∑–Ω–∏–∫–∞)
‚Ä¢ –ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ –ø—Ä–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ –≤—ñ–¥ 1000 –≥—Ä–Ω

üìû *–ö–æ–Ω—Ç–∞–∫—Ç–∏ –¥–ª—è –∑–≤'—è–∑–∫—É:*
‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω: +380XXXXXXXXX
‚Ä¢ Telegram: @–≤–∞—à_–∫–æ–Ω—Ç–∞–∫—Ç

–í—Å–µ –∑—Ä–æ–∑—É–º—ñ–ª–æ? üëá
"""

ORDER_TEXT = """
üì¶ *–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è*

–ù–∞–ø–∏—à—ñ—Ç—å, —â–æ –≤–∞—Å —Ü—ñ–∫–∞–≤–∏—Ç—å:
‚Ä¢ –ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É
‚Ä¢ –ö—ñ–ª—å–∫—ñ—Å—Ç—å
‚Ä¢ –í–∞—à—ñ –∫–æ–Ω—Ç–∞–∫—Ç–∏
‚Ä¢ –ë–∞–∂–∞–Ω–∏–π —Å–ø–æ—Å—ñ–± –¥–æ—Å—Ç–∞–≤–∫–∏

*–ü—Ä–∏–∫–ª–∞–¥ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:*
"Chaser 30 ml for pods - 2 —à—Ç, Vaporesso XROS 3 - 1 —à—Ç, –¥–æ—Å—Ç–∞–≤–∫–∞ –ù–æ–≤–∞ –ü–æ—à—Ç–∞, —Ç–µ–ª–µ—Ñ–æ–Ω 0991234567"

–ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –∑–≤'—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –ø—Ä–æ—Ç—è–≥–æ–º 5-15 —Ö–≤–∏–ª–∏–Ω –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π.

*–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à—ñ—Ç—å —Å–≤–æ—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∏–∂—á–µ:*
"""

INFO_TEXT = """
‚ÑπÔ∏è *–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –±–æ—Ç–∞*

ü§ñ *–Ø–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è –±–æ—Ç–æ–º:*
1. –û–±–µ—Ä—ñ—Ç—å üõçÔ∏è –ê—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Ç–æ–≤–∞—Ä—ñ–≤
2. –û–±–∏—Ä–∞–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó —Ç–∞ —Ç–æ–≤–∞—Ä–∏
3. –î–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å üì¶ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è
4. –ù–∞–ø–∏—à—ñ—Ç—å —â–æ –≤–∞—Å —Ü—ñ–∫–∞–≤–∏—Ç—å
5. –û—á—ñ–∫—É–π—Ç–µ –¥–∑–≤—ñ–Ω–∫–∞ –≤—ñ–¥ –º–µ–Ω–µ–¥–∂–µ—Ä–∞

üí≥ *–°–ø–æ—Å–æ–±–∏ –æ–ø–ª–∞—Ç–∏:*
‚Ä¢ –ù–∞ –∫–∞—Ä—Ç—É
‚Ä¢ –û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ
‚Ä¢ Google Pay / Apple Pay

üîÑ *–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è/–æ–±–º—ñ–Ω:*
‚Ä¢ –í–ø—Ä–æ–¥–æ–≤–∂ 14 –¥–Ω—ñ–≤
‚Ä¢ –¢–æ–≤–∞—Ä –º–∞—î –±—É—Ç–∏ –≤ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ–π —É–ø–∞–∫–æ–≤—Ü—ñ

‚ùì *–ß–∞—Å—Ç—ñ –ø–∏—Ç–∞–Ω–Ω—è:*
Q: –ß–∏ —î –¥–æ—Å—Ç–∞–≤–∫–∞ –≤ –º–æ—î –º—ñ—Å—Ç–æ?
A: –¢–∞–∫, –¥–æ—Å—Ç–∞–≤–ª—è—î–º–æ –ø–æ –≤—Å—ñ–π –£–∫—Ä–∞—ó–Ω—ñ

Q: –Ø–∫ –¥–æ–≤–≥–æ —Ç—Ä–∏–≤–∞—î –¥–æ—Å—Ç–∞–≤–∫–∞?
A: 1-5 –¥–Ω—ñ–≤ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –º—ñ—Å—Ü—è –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è

Q: –ß–∏ —î –≥–∞—Ä–∞–Ω—Ç—ñ—è?
A: –¢–∞–∫, –≥–∞—Ä–∞–Ω—Ç—ñ—è –≤—ñ–¥ –≤–∏—Ä–æ–±–Ω–∏–∫–∞

üìû *–ö–æ–Ω—Ç–∞–∫—Ç–∏ –¥–ª—è –∑–≤'—è–∑–∫—É:*
@–≤–∞—à_support
+380XXXXXXXXX
"""

# ==================== –û–ë–†–û–ë–ù–ò–ö–ò –ö–û–ú–ê–ù–î ====================
@bot.message_handler(commands=['start', 'help', 'menu'])
def send_welcome(message):
    """–û–±—Ä–æ–±–∫–∞ –∫–æ–º–∞–Ω–¥ /start, /help, /menu"""
    bot.send_message(message.chat.id, WELCOME_TEXT, 
                    parse_mode='Markdown', reply_markup=main_menu())

# ==================== –û–ë–†–û–ë–ù–ò–ö–ò –ì–û–õ–û–í–ù–û–ì–û –ú–ï–ù–Æ ====================
@bot.message_handler(func=lambda m: m.text in ["üõçÔ∏è –ê—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç", "üöö –î–æ—Å—Ç–∞–≤–∫–∞", 
                                              "üì¶ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è", "‚ÑπÔ∏è –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ"])
def handle_main_menu(message):
    """–û–±—Ä–æ–±–∫–∞ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é"""
    text = message.text
    chat_id = message.chat.id
    
    if text == "üõçÔ∏è –ê—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç":
        bot.send_message(chat_id, "–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é —Ç–æ–≤–∞—Ä—ñ–≤:", 
                        reply_markup=assortment_menu())
    
    elif text == "üöö –î–æ—Å—Ç–∞–≤–∫–∞":
        bot.send_message(chat_id, DELIVERY_TEXT, 
                        parse_mode='Markdown', reply_markup=delivery_menu())
    
    elif text == "üì¶ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è":
        bot.send_message(chat_id, ORDER_TEXT, 
                        parse_mode='Markdown', reply_markup=order_menu())
        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        user_states[message.from_user.id] = "waiting_for_order"
    
    elif text == "‚ÑπÔ∏è –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ":
        bot.send_message(chat_id, INFO_TEXT, parse_mode='Markdown')
        bot.send_message(chat_id, "–û–±–µ—Ä—ñ—Ç—å –ø—É–Ω–∫—Ç –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω—ñ—à–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó:",
                        reply_markup=info_menu())

# ==================== –û–ë–†–û–ë–ù–ò–ö–ò –ê–°–û–†–¢–ò–ú–ï–ù–¢–£ ====================
@bot.message_handler(func=lambda m: m.text in ["üíß –†—ñ–¥–∏–Ω–∏", "üîã –ü–æ–¥-—Å–∏—Å—Ç–µ–º–∏", 
                                              "üéØ –ö–∞—Ä—Ç—Ä–∏–¥–∂—ñ"])
def handle_assortment(message):
    """–û–±—Ä–æ–±–∫–∞ –º–µ–Ω—é –∞—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç—É"""
    text = message.text
    chat_id = message.chat.id
    
    if text == "üíß –†—ñ–¥–∏–Ω–∏":
        bot.send_message(chat_id, "–û–±–µ—Ä—ñ—Ç—å —Ä—ñ–¥–∏–Ω—É:", reply_markup=liquids_menu())
    
    elif text == "üîã –ü–æ–¥-—Å–∏—Å—Ç–µ–º–∏":
        bot.send_message(chat_id, "–û–±–µ—Ä—ñ—Ç—å –ø–æ–¥-—Å–∏—Å—Ç–µ–º—É:", reply_markup=pods_menu())
    
    elif text == "üéØ –ö–∞—Ä—Ç—Ä–∏–¥–∂—ñ":
        bot.send_message(chat_id, "–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ä—Ç—Ä–∏–¥–∂—ñ:", reply_markup=cartridges_menu())

# ==================== –û–ë–†–û–ë–ù–ò–ö–ò –Ü–ù–§–û–†–ú–ê–¶–Ü–ô–ù–û–ì–û –ú–ï–ù–Æ ====================
@bot.message_handler(func=lambda m: m.text in ["–Ø–∫ –∑–∞–º–æ–≤–∏—Ç–∏?", "–û–ø–ª–∞—Ç–∞ —Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∞",
                                              "–ì–∞—Ä–∞–Ω—Ç—ñ—è"])
def handle_info_menu(message):
    """–û–±—Ä–æ–±–∫–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–æ–≥–æ –º–µ–Ω—é"""
    text = message.text
    chat_id = message.chat.id
    
    if text == "–Ø–∫ –∑–∞–º–æ–≤–∏—Ç–∏?":
        response = """
üìù *–Ø–∫ –∑—Ä–æ–±–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:*
        
1. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å üõçÔ∏è –ê—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç
2. –û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä–∏
3. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å üì¶ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è
4. –ù–∞–ø–∏—à—ñ—Ç—å —â–æ –≤–∞—Å —Ü—ñ–∫–∞–≤–∏—Ç—å
5. –û—á—ñ–∫—É–π—Ç–µ –¥–∑–≤—ñ–Ω–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        
–¶–µ –ø—Ä–æ—Å—Ç–æ! üòä
        """
    
    elif text == "–û–ø–ª–∞—Ç–∞ —Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∞":
        response = """
üí≥ *–û–ø–ª–∞—Ç–∞ —Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∞:*
        
üí∏ *–°–ø–æ—Å–æ–±–∏ –æ–ø–ª–∞—Ç–∏:*
‚Ä¢ –ü–µ—Ä–µ–¥–ø–ª–∞—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç—É
‚Ä¢ –û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ
‚Ä¢ Google Pay / Apple Pay
        
üöö *–î–æ—Å—Ç–∞–≤–∫–∞:*
‚Ä¢ –ù–æ–≤–∞ –ø–æ—à—Ç–∞ (1-3 –¥–Ω—ñ)
‚Ä¢ –£–∫—Ä–ø–æ—à—Ç–∞ (2-5 –¥–Ω—ñ–≤)
‚Ä¢ –°–∞–º–æ–≤–∏–≤—ñ–∑ (–ö–∏—ó–≤)
        
üí∞ *–í–∞—Ä—Ç—ñ—Å—Ç—å:*
‚Ä¢ –í—ñ–¥ 50 –≥—Ä–Ω
‚Ä¢ –ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ –≤—ñ–¥ 1000 –≥—Ä–Ω
        """
    
    else:  # "–ì–∞—Ä–∞–Ω—Ç—ñ—è"
        response = """
üõ°Ô∏è *–ì–∞—Ä–∞–Ω—Ç—ñ—è —Ç–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è:*
        
‚úÖ *–ì–∞—Ä–∞–Ω—Ç—ñ—è:*
‚Ä¢ –ù–∞ –≤—Å—ñ —Ç–æ–≤–∞—Ä–∏ - 14 –¥–Ω—ñ–≤
‚Ä¢ –û—Ñ—ñ—Ü—ñ–π–Ω–∞ –≥–∞—Ä–∞–Ω—Ç—ñ—è –≤–∏—Ä–æ–±–Ω–∏–∫–∞
        
üîÑ *–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è:*
‚Ä¢ –í–ø—Ä–æ–¥–æ–≤–∂ 14 –¥–Ω—ñ–≤
‚Ä¢ –¢–æ–≤–∞—Ä –º–∞—î –±—É—Ç–∏ –≤ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ–π —É–ø–∞–∫–æ–≤—Ü—ñ
‚Ä¢ –ó–±–µ—Ä–µ–∂–µ–Ω–∞ —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å —É–ø–∞–∫–æ–≤–∫–∏
        
üìû *–ó–∞ –ø–∏—Ç–∞–Ω–Ω—è–º–∏:*
@–≤–∞—à_support
        """
    
    bot.send_message(chat_id, response, parse_mode='Markdown')
    bot.send_message(chat_id, "–©–µ –ø–∏—Ç–∞–Ω–Ω—è?", reply_markup=info_menu())

# ==================== –û–ë–†–û–ë–ù–ò–ö–ò –¢–û–í–ê–†–Ü–í ====================
@bot.message_handler(func=lambda m: any(keyword in m.text for keyword in 
                                       ["Chaser", "Xlim", "Vaporesso", "–ö–∞—Ä—Ç—Ä–∏–¥–∂—ñ", "–Ü–Ω—à—ñ"]))
def handle_products(message):
    """–û–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É —Ç–æ–≤–∞—Ä—ñ–≤"""
    text = message.text
    chat_id = message.chat.id
    
    if text == "–Ü–Ω—à—ñ –±—Ä–µ–Ω–¥–∏":
        response = "–Ü–Ω—à—ñ –±—Ä–µ–Ω–¥–∏ –ø–æ–¥-—Å–∏—Å—Ç–µ–º:\n\n‚Ä¢ SMOK\n‚Ä¢ GeekVape\n‚Ä¢ Voopoo\n‚Ä¢ OXVA\n‚Ä¢ Uwell"
        bot.send_message(chat_id, response)
    else:
        product_info = f"""
üè∑Ô∏è *{text}*

üí∞ –¶—ñ–Ω–∞: –≤—ñ–¥ 299 –≥—Ä–Ω
üì¶ –ù–∞—è–≤–Ω—ñ—Å—Ç—å: ‚úÖ –í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ
‚≠ê –†–µ–π—Ç–∏–Ω–≥: 4.8/5

*–û–ø–∏—Å:*
–í–∏—Å–æ–∫–∞ —è–∫—ñ—Å—Ç—å, –ø—Ä–∏—î–º–Ω–∏–π —Å–º–∞–∫, –¥–æ–≤–≥–æ—Ç—Ä–∏–≤–∞–ª–∞ —Ä–æ–±–æ—Ç–∞.

–î–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å üì¶ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —É –≥–æ–ª–æ–≤–Ω–æ–º—É –º–µ–Ω—é.
"""
        bot.send_message(chat_id, product_info, parse_mode='Markdown')

# ==================== –û–ë–†–û–ë–ù–ò–ö –ù–ê–ó–ê–î ====================
@bot.message_handler(func=lambda m: m.text in ["–ù–∞–∑–∞–¥ ‚óÄÔ∏è", "–¢–∞–∫, –∑—Ä–æ–∑—É–º—ñ–ª–æ ‚úÖ", 
                                              "–°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚ùå"])
def handle_back(message):
    """–û–±—Ä–æ–±–∫–∞ –∫–Ω–æ–ø–æ–∫ –ù–∞–∑–∞–¥ —Ç–∞ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è"""
    text = message.text
    chat_id = message.chat.id
    user_id = message.from_user.id
    
    # –û—á–∏—â–∞—î–º–æ —Å—Ç–∞–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    if user_id in user_states:
        del user_states[user_id]
    
    if text == "–°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚ùå":
        bot.send_message(chat_id, "‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ.", reply_markup=main_menu())
    elif text == "–¢–∞–∫, –∑—Ä–æ–∑—É–º—ñ–ª–æ ‚úÖ":
        bot.send_message(chat_id, "–ß—É–¥–æ–≤–æ! üòä", reply_markup=main_menu())
    else:  # "–ù–∞–∑–∞–¥ ‚óÄÔ∏è"
        bot.send_message(chat_id, "–ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å —É –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é:", reply_markup=main_menu())
    
    return

# ==================== –û–ë–†–û–ë–ù–ò–ö –í–°–Ü–• –ü–û–í–Ü–î–û–ú–õ–ï–ù–¨ ====================
@bot.message_handler(func=lambda m: True)
def handle_all_messages(message):
    """–û–±—Ä–æ–±–∫–∞ –≤—Å—ñ—Ö —ñ–Ω—à–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å"""
    text = message.text
    chat_id = message.chat.id
    user_id = message.from_user.id
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤ —Ä–µ–∂–∏–º—ñ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
    if user_id in user_states and user_states[user_id] == "waiting_for_order":
        # –Ø–∫—â–æ –Ω–∞—Ç–∏—Å–Ω—É–ª–∏ "–°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚ùå"
        if text == "–°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚ùå":
            del user_states[user_id]
            bot.send_message(chat_id, "‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ.", reply_markup=main_menu())
            return
        
        # –Ø–∫—â–æ —Ü–µ —Ç–µ–∫—Å—Ç –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        process_order(message)
        return
    
    # –Ø–∫—â–æ —Ü–µ –Ω–µ –∫–Ω–æ–ø–∫–∞ –∑ –º–µ–Ω—é - –ø–æ–∫–∞–∑—É—î–º–æ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é
    bot.send_message(chat_id, "–û–±–µ—Ä—ñ—Ç—å –ø—É–Ω–∫—Ç –∑ –º–µ–Ω—é üëá", reply_markup=main_menu())

# ==================== –û–ë–†–û–ë–ö–ê –ó–ê–ú–û–í–õ–ï–ù–¨ ====================
def process_order(message):
    """–û–±—Ä–æ–±–∫–∞ —Ç–µ–∫—Å—Ç—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞"""
    chat_id = message.chat.id
    user_id = message.from_user.id
    
    # –û—á–∏—â–∞—î–º–æ —Å—Ç–∞–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    if user_id in user_states:
        del user_states[user_id]
    
    user_name = message.from_user.first_name
    username = f"@{message.from_user.username}" if message.from_user.username else "–Ω–µ–º–∞—î"
    order_text = message.text
    
    # –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å–∫–∞—Å—É–≤–∞–≤
    if order_text == "–°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚ùå":
        bot.send_message(chat_id, "‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ.", reply_markup=main_menu())
        return
    
    # –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
    user_response = f"""
‚úÖ *–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ!*

–ú–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –≤–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:
"{order_text}"

–ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –∑–≤'—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –ø—Ä–æ—Ç—è–≥–æ–º 5-15 —Ö–≤–∏–ª–∏–Ω.

–î—è–∫—É—î–º–æ –∑–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è! üôè
"""
    bot.send_message(chat_id, user_response, parse_mode='Markdown', reply_markup=main_menu())
    
    # –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –∞–¥–º—ñ–Ω-–≥—Ä—É–ø—É
    admin_message = f"""
üì¶ *–ù–û–í–ï –ó–ê–ú–û–í–õ–ï–ù–ù–Ø* üì¶

üë§ *–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:* {user_name}
üì± *Username:* {username}
üÜî *ID:* {user_id}

üìù *–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:*
{order_text}

‚è∞ *–ß–∞—Å:* {message.date}
üí¨ *–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏:* [–ù–∞–ø–∏—Å–∞—Ç–∏](tg://user?id={user_id})
"""
    
    try:
        bot.send_message(ADMIN_GROUP_ID, admin_message, parse_mode='Markdown')
        print(f"‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –≥—Ä—É–ø—É: {user_name}")
    except Exception as e:
        print(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤ –≥—Ä—É–ø—É: {e}")
        # –ú–æ–∂–Ω–∞ –∑–±–µ—Ä–µ–≥—Ç–∏ –≤ —Ñ–∞–π–ª –∞–±–æ –±–∞–∑—É –¥–∞–Ω–∏—Ö
        with open("orders.log", "a", encoding="utf-8") as f:
            f.write(f"{user_id}|{user_name}|{order_text}|{message.date}\n")

# ==================== –í–ï–ë–•–£–ö –¢–ê FLASK ====================
@app.route('/')
def index():
    return "ü§ñ –ë–æ—Ç –ø—Ä–∞—Ü—é—î! –ü–µ—Ä–µ–π–¥—ñ—Ç—å —É Telegram: @–≤–∞—à_–±–æ—Ç"

@app.route('/set_webhook')
def set_webhook():
    """–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–µ–±—Ö—É–∫–∞"""
    webhook_url = f"https://telegram-bot-iss2.onrender.com/{TOKEN}"
    bot.remove_webhook()
    bot.set_webhook(url=webhook_url)
    return f"‚úÖ –í–µ–±—Ö—É–∫ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: {webhook_url}"

@app.route(f'/{TOKEN}', methods=['POST'])
def webhook():
    """–û–±—Ä–æ–±–∫–∞ –≤–µ–±—Ö—É–∫–∞ –≤—ñ–¥ Telegram"""
    if request.headers.get('content-type') == 'application/json':
        json_string = request.get_data().decode('utf-8')
        update = telebot.types.Update.de_json(json_string)
        bot.process_new_updates([update])
        return 'OK'
    return 'ERROR', 400

# ==================== –ó–ê–ü–£–°–ö ====================
if __name__ == '__main__':
    port = int(os.environ.get('PORT', 10000))
    print(f"üöÄ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –Ω–∞ –ø–æ—Ä—Ç—ñ {port}...")
    print(f"üîó –í–µ–±—Ö—É–∫: https://telegram-bot-iss2.onrender.com/{TOKEN}")
    app.run(host='0.0.0.0', port=port)
